pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
local angles={}
function make_cam(x,y)
	return {
		pos={x,y},
		angle=0,
	 project2d=function(self,x,y)
	 	return x*8,128-y*8
	 end
	}
end

local cam=make_cam(0,0)
function _update()
	local dx,dy=0,0
	if(btn(2)) dx=1
	if(btn(3)) dx=-1
	if(btn(0)) dy=1
	if(btn(1)) dy=-1

	cam.angle+=dy/64
	local cc,ss=cos(cam.angle),-sin(cam.angle)
	cam.pos[1]+=dx*cc/16
	cam.pos[2]+=dx*ss/16
end

function solid(i,j)
	return mget(i,j)!=0
end

function wallhit(posx,posy,u,v,out)
 local mapx,mapy=flr(posx),flr(posy)

 local ddx,ddy=abs(1/u),abs(1/v)
 local mapdx,distx
 if u<0 then
 	mapdx=-1
  distx=(posx-mapx)*ddx
 else
 	mapdx=1
  distx=(mapx+1-posx)*ddx
 end
	local mapdy,disty
 if v<0 then
 	mapdy=-1
  disty=(posy-mapy)*ddy
 else
 	mapdy=1
  disty=(mapy+1-posy)*ddy
 end	
 for dist=0,3 do
		-- non solid visible tiles
		if(mapx>=0 and mapy>=0 and mapx<64 and mapy<64) then
			out[mapx+64*mapy]={mapx,mapy}
		end
		if distx<disty then
			distx+=ddx
			mapx+=mapdx
		else
			disty+=ddy
			mapy+=mapdy
		end
	end
end

function _init()
	for i=0,127 do
 	add(angles,atan2(64,i-64))
 end
end

function _draw()
 cls()

 --
	local tiles,x,y={},cam.pos[1],cam.pos[2]
 for i=1,128 do
 	
 	local angle=angles[i]+cam.angle
 	local u,v=cos(angle),-sin(angle)
 	
		wallhit(x,y,u,v,tiles)
				
	end	
	for k,v in pairs(tiles) do
		x,y=cam:project2d(v[1],v[2])
		spr(1,x,y)
	end	
	x,y=cam:project2d(cam.pos[1],cam.pos[2])
	
	local u,v=cos(cam.angle),-sin(cam.angle)
	u+=cam.pos[1]
	v+=cam.pos[2]	
	x1,y1=cam:project2d(u,v)
	line(x,y,x1,y1,9)
	pset(x,y,8)
  
	local cpu=flr(1000*stat(1))/10
	print(cpu,2,3,5)
	print(cpu,2,2,7)
 print(cam.pos[1].."/"..cam.pos[2],2,12,7)
end

__gfx__
00000000555555559991999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555554491444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700555555551111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000555555559999919900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000555555554444914400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700555555551111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555559991999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555555554491444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000015d67000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1050f1d1c0e061101037d968720a68a26a68139a68437978d2c978f23a78437a7863597823a978531a78b35a78d37988a3e988f31a88243988735988c3998844
b988843988c33988543988944888734888c3588854588894d78873f788d32888545888940778f38788340888744888a41778946788a4f788b43888b437783577
78150878e44878c48778a5c778752878055878d4e778064878c5b87865e878450878166868f5e868e53968d5086826586846d86876196896f768262868767868
e6986827d75826d75886e75817e75857873826773876573807473847372806071856c618d6a61817e618d5b608165608862608b6c618a57608d5060826c50846
3608c4f5080585086555f7a565f75455f7a425f73515f77594e764b4e7b4e4e73505e77504d7c444d705a4e765d4e795a3d745f3d76564d7b5a4d7d573d7c5c3
d7d554d7e594d7f573d776c3d77654d76694d75693d707e3d7e674d7c6b4d7a6c3f7a724f797b4f787f4f777d3f7c72408d7a408f7e40818a30818e308387408
78a408985318c8a318d824180964281943287993286924285964284993382ad338f94438a9843879c4482bf448ea35486a55482a45385b55380b85388a95383a
b5386bb5381bb5388ac5384a26286b16281b06288af5283a86284b7628fa46287a36283a0728cae6283ae628f937281b3728ca57283a5728e96728caa7284ac7
280a8728eaf7288a28285a97280b2828da6828baa7282b38282b78281b5728cba728cb3828ab78289b77284cc7282c4828eba728ace7286c58280c8828db0828
ec2828ac78282c78281d8828cca8283cb828fb69281d5928cc49283c4928fbe928fcc928ac89282c7928eb6a38ac2a387cc9380c9938dbba481c6a480ce948db
a948bb8a587bf9585bb9584bda587b9a584b1a58fad958daba682b6a68ba3a687a7b781b5b78ca0b785ada781aeb88caab888a4b882a0b88f93c885aeb883a6b
88f92b88d96c88c91c88a98b88894b88797c88292c88299b88295b88297c78981c78a89b78b84b78c84c68f7fb68187b68382b6848fb48a69b48b60b48d6ca48
d6fb4886ab48661b4846da48264c5806fb58d59b58855b5865ac68455c6825db68f49b68e4dc78548c7854fb7864ab7864ac88935c88a3cb88d38b88e34c88d2
0c88038b88434b88730c7872cb78a25b78032b78438b78126b78623b78e21b7823da6802ea6852fa68e20b68234a68226a6872aa68e2ba68330608f645f70615
e7e5e4e706e4e75635f737aa78b36a78644b78642b78a3fa7883da7883fa5835ea78e39968166a48a6d8d8a70738c7c8287be828ab3938ab59387b9948baa828
aa09289b6a78d9ca88a9fa7819aa6868650868e42819e428799538e9e528d9c628792828b9b978c16d68755d98438c78d10b78411988523d68284d68e65c78bb
0d88da5d889967289d5818fd2a38dd5b48dc7218f8f238cad4382cd5288ca628bce418a363d744a2c77592d7d68208d79888a2d788f2d6885395b89197c8d079
b8407dc8110fb8e4ee98587ea8cb3c586e6858cfe548ee73486dc03879d00886e1084310eee18ea2708c947f8c957f89937f8b947f8ba3708ba08080a08080a0
8080a08080a08080a08080a08080a08080a08070ab8080a08080a08070ad8082918f86938d8da08080a08080a08080a48084a28085a18083938f86a08080a080
80a08080a08070988f72ac8072ad8071957e7f988f70997f7f988f70997f7e9a7f7e988f72ac707ead707e9c8f84a08080a08070ad8081a08070ac8071ae707f
ad707eac8072ad8070ab8070948e71ad8072ad8080a08080a08070ad8071ad8085a08080a08080a08080a08080a08080a08080a08080a08080a08070ad708b90
7f8aa0707cae708ca08080a08080a1708da1707d9e7f8aa0708da1707cac707caf707daf707c9d7f8aa48082a58082968f82a08080a08080a08080a58080968f
80988f80a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080
a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08070ad80729b8f73988f75af8073ad80749a8e88a08073af8074ae
8084a08080a08080a080709a8e799b8f75ad8073ac8072ac80749b8f85a08080a08080a08080a08080a08080a08080a08080a08080a08080a0708ca0707caf70
7baf707daf707caf708ca08080a08080a08070af8073af8072af8082a08082a08083a08084a08083a18083a08074ad707cad707c9b7f8ba08080a08080a08070
ad8070ab707f947e8fa08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08080a08070ae8074ae8072ae8072af
707daf708da0707daf8073af8072af8082a08080a08080a08080a08080a08080a08080a08080a08080a08070af707faf707faf707fae707baf707b9f7f8ba080
80a08080a08080a08080a08070ae708f9d8a7d988e78af8074ac707c9a8f73978f719a8f709a7f7d9a8f70978f81a08080a08060998783a08070948d74ac708f
a08070ab80729b7f7ead8080a08083977f8fa08080a08080997e7a9d7f7bac707c9f7f6a9a7689a0708ba08070928d80a08070988f85a080749a8f81a08074ae
8073af8085a08080a08080a08080a08080a08080a08080a08085a48074ae8082a38073af8082a08080a38082a38083a0807091787292797299697e9a7f7d967b
739b7f7dad707fae708ba08080a08080a08080a08080a08080a08080928f769a8f77998c7e948c88a08070978f73997f7e957e7fac707e9a7d74987e7a9d8f87
a0707daf707c9c7f7cae707eab708fa08070ae708ca080709b8f78ac8073ae8073997f7e9a8f81987f8ba08080a08080a08080a080809a7e8e967f8d988f8095
7e87917f89957d83a08080a08080907f88a080709e7f89a08080a08080a08080a08080a08080a08080a0708ea1708ca3707cad707fad8071968e77ab80739b8e
79ac708d909777959972969873938a7d958b7d918c769a8e88a08083a08080a08080a08080a080809c7e8fa08080a38081978f82a48081a28083a18083a18073
ad8082a08080a08070ac707dae8071af707eae8073af8072ae8073af8072ac8072ae8070ad8080a1707dad8080a1708da2708ca1708da08080a08080a08080a0
8070ae8083a080729d8f75ad8073ad8072ab707fae8070af708ea08072ae8070af8082a08080a28081a08080a08080a08080a08080a08080a08080a08080a580
81a08080a18082a38072af707fae8072ae707eaf707daf707eaf708d917f8aa0708ea1708f917f89917f8aa08070ae8070af707f9e8f77ae80729e8f87a08070
ae707fae8080a08080a08070ad8073ae8070ae707caf707dab8071ad8070ad8071ae707fad707eae707fac80709a7f7fab80719b8f73978f72ab8082a280759d
8f799d8e8ca28083978f84a28083a18084a18083a08084a2708f947f8ca0708da0708ea28080a1708ea1708fa2708da1708f947f8aa2708ea2708ea4708fa280
83958f729e8f789a8f779e8f79998e79928d71938b7c928b79928b8a988f80997f8da08071ac8072af707eac8081a0800